import React, { useState, useEffect } from 'react';
import { 
  Plane, 
  Train, 
  Car, 
  MapPin, 
  Utensils, 
  Camera, 
  Info, 
  Phone, 
  CreditCard, 
  Sun, 
  CloudRain, 
  Cloud, 
  ChevronRight, 
  X,
  Navigation,
  Calendar,
  Briefcase,
  Home
} from 'lucide-react';

// --- Types & Data Structures ---

type ItineraryItem = {
  id: string;
  time: string;
  title: string;
  type: 'transport' | 'spot' | 'food' | 'hotel' | 'flight';
  location: string;
  description?: string;
  tips?: string[]; // å¿…åƒã€å¿…è²·ã€æ”»ç•¥
  bookingCode?: string; // é ç´„ä»£è™Ÿ/é—œéµå­—
  bookingImage?: string; // æ¨¡æ“¬ç¥¨åˆ¸åœ–ç‰‡
  lat?: number; // For navigation
  lng?: number; // For navigation
};

type DayPlan = {
  date: string;
  dayOfWeek: string;
  weather: { temp: string; icon: 'sun' | 'rain' | 'cloud' };
  items: ItineraryItem[];
};

// --- Mock Data (Based on user's PDF + Suggestion) ---

const itineraryData: DayPlan[] = [
  {
    date: '12/3',
    dayOfWeek: 'é€±ä¸‰',
    weather: { temp: '14Â°C', icon: 'cloud' },
    items: [
      {
        id: '1-1',
        time: '07:30',
        title: 'æ˜Ÿå®‡èˆªç©º JX846',
        type: 'flight',
        location: 'æ¡ƒåœ’æ©Ÿå ´ (TPE) T1',
        description: 'é£›å¾€ç†Šæœ¬ (KMJ)ï¼Œé è¨ˆ 10:30 æŠµé”ã€‚',
        bookingCode: 'REF: KYU-1203-STAR',
        tips: ['ğŸ’¡ è¨˜å¾—æå‰2å°æ™‚æŠµé”æ©Ÿå ´', 'ğŸ’¡ é£›æ©Ÿé¤æ¨è–¦èƒ¡åŒç‡’è‚‰'],
      },
      {
        id: '1-2',
        time: '12:00',
        title: 'æ©Ÿå ´å·´å£«ç§»å‹•',
        type: 'transport',
        location: 'ç†Šæœ¬æ©Ÿå ´ â†’ ç†Šæœ¬ç«™',
        description: 'æ­ä¹˜æ©Ÿå ´åˆ©æœ¨æ´¥å·´å£«å‰å¾€å¸‚å€ã€‚',
        tips: ['ğŸ’¡ å¯ä½¿ç”¨ IC å¡ (Suica/ICOCA)'],
      },
      {
        id: '1-3',
        time: '13:00',
        title: 'æ–°å¹¹ç·š ç‘ç©—/æ«»èŠ±è™Ÿ',
        type: 'transport',
        location: 'ç†Šæœ¬ç«™ â†’ åšå¤šç«™',
        description: 'è½‰ä¹˜æ–°å¹¹ç·šå‰å¾€ç¦å²¡ï¼Œè»Šç¨‹ç´„ 32 åˆ†é˜ã€‚',
        tips: ['âš ï¸ å‹™å¿…é ç´„ã€Œç‰¹å¤§è¡Œæå¸­ã€', 'ğŸ’¡ æ¨è–¦åœ¨è»Šç«™è²·ç†Šæœ¬ç†Šä¾¿ç•¶'],
        bookingCode: 'JR-RES-9988'
      },
      {
        id: '1-4',
        time: '14:30',
        title: 'KOKO HOTEL ç¦å²¡å¤©ç¥',
        type: 'hotel',
        location: 'ç¦å²¡ç¸£ç¦å²¡å¸‚ä¸­å¤®å€ä»Šæ³‰1-22-14',
        description: 'Check-in å¯„æ”¾è¡Œæã€‚ä½æ–¼å¤©ç¥å—ç«™é™„è¿‘ï¼Œäº¤é€šæ–¹ä¾¿ã€‚',
        bookingCode: 'AGODA-55214'
      },
      {
        id: '1-5',
        time: '15:30',
        title: 'æ«›ç”°ç¥ç¤¾',
        type: 'spot',
        location: 'ç¦å²¡å¸‚åšå¤šå€ä¸Šå·ç«¯ç”ºï¼‘âˆ’41',
        description: 'åšå¤šç¸½é®å®ˆï¼Œå¿…çœ‹å·¨å¤§çš„è£é£¾å±±ç¬ ã€‚',
        tips: ['ğŸ’¡ å¿…è²·ï¼šåšå¤šç¹”å¾¡å®ˆ', 'ğŸ’¡ åƒæ‹œå¾Œå¯é€›æ—é‚Šçš„å·ç«¯é€šå•†åº—è¡—']
      },
      {
        id: '1-6',
        time: '18:30',
        title: 'åšå¤šæ‘©æ»‹é‹ (æ™šé¤)',
        type: 'food',
        location: 'åšå¤šæ‘©æ»‹é‹ å‰ç”°å±‹/å¤§å±±',
        description: 'ç¦å²¡å¿…åƒç‰›è…¸é‹ï¼Œæ¿ƒéƒå‘³å™Œå£å‘³ã€‚',
        tips: ['ğŸ”¥ å¿…é»ï¼šå‘³å™Œå£å‘³ç‰›è…¸é‹', 'ğŸ”¥ æ”¶å°¾å¿…é»ï¼šå¼·æ£’éºµ']
      }
    ]
  },
  {
    date: '12/4',
    dayOfWeek: 'é€±å››',
    weather: { temp: '12Â°C', icon: 'sun' },
    items: [
      {
        id: '2-1',
        time: '09:00',
        title: 'ç§»å‹•ï¼šè¥¿éµé›»è»Š',
        type: 'transport',
        location: 'è¥¿éµç¦å²¡(å¤©ç¥) â†’ å¤ªå®°åºœ',
        description: 'æ­ä¹˜æ—…äººè™Ÿè§€å…‰åˆ—è»Š(å¦‚æœ‰é‡åˆ°)ã€‚',
      },
      {
        id: '2-2',
        time: '10:00',
        title: 'å¤ªå®°åºœå¤©æ»¿å®®',
        type: 'spot',
        location: 'å¤ªå®°åºœå¤©æ»¿å®®',
        description: 'å­¸å•ä¹‹ç¥ï¼Œè³æ¢…åæ‰€ï¼ˆé›–ç„¶ç¾åœ¨æ˜¯å†¬å¤©ï¼‰ã€‚',
        tips: ['ğŸ¥¯ å¿…åƒï¼šæ¢…æé¤… (æ¨è–¦åŠ è–©è«¾äº Kasanoya)', 'ğŸ’¡ æ‘¸å¾¡ç¥ç‰›çš„é ­æœƒè®Šè°æ˜']
      },
      {
        id: '2-3',
        time: '12:00',
        title: 'ä¸€è˜­æ‹‰éºµ å¤ªå®°åºœåƒé“åº—',
        type: 'food',
        location: 'å¤ªå®°åºœåƒé“',
        description: 'å…¨çƒå”¯ä¸€çš„äº”è§’å½¢ç¢—ï¼Œè±¡å¾µã€Œåˆæ ¼ã€ã€‚',
        tips: ['ğŸ”¥ éºµæ¢æ¯”ä¸€èˆ¬çš„é•·(è±¡å¾µé•·å£½/é•·ä¹…)', 'ğŸ’¡ æ¹¯å–å®Œç¢—åº•æœ‰ã€Œæ±ºå®šã€äºŒå­—']
      },
      {
        id: '2-4',
        time: '14:00',
        title: 'ç«ˆé–€ç¥ç¤¾',
        type: 'spot',
        location: 'ç«ˆé–€ç¥ç¤¾',
        description: 'é¬¼æ»…ä¹‹åˆƒè–åœ°ï¼Œçµç·£ç¥ç¤¾ã€‚éœ€æ­ä¹˜ç¤¾å€å·´å£«ã€Œæ‘©è¨¶è€¶ã€ã€‚',
        tips: ['ğŸ’¡ é€™è£¡çš„å¾¡å®ˆè¨­è¨ˆéå¸¸æ™‚å°šï¼Œé©åˆç•¶ä¼´æ‰‹ç¦®']
      }
    ]
  },
  {
    date: '12/5',
    dayOfWeek: 'é€±äº”',
    weather: { temp: '8Â°C', icon: 'cloud' },
    items: [
      {
        id: '3-1',
        time: '09:00',
        title: 'ç§Ÿè»Šå–è»Š',
        type: 'transport',
        location: 'TOYOTA Rent a Car è—¥é™¢ç«™å‰åº—',
        description: 'è¾¦ç†ç§Ÿè»Šæ‰‹çºŒï¼Œç¢ºèª ETC å¡ã€‚',
        bookingCode: 'RES: TOYOTA-8821',
        tips: ['âš ï¸ æª¢æŸ¥è»Šèº«åˆ®ç—•', 'âš ï¸ è¨­å®šå°èˆªè‡³é˜¿è˜‡']
      },
      {
        id: '3-2',
        time: '12:30',
        title: 'é˜¿è˜‡èµ¤ç‰›ä¸¼ (åˆé¤)',
        type: 'food',
        location: 'é˜¿è˜‡ Imakiné£Ÿå ‚ (æˆ–å‘¨é‚Š)',
        description: 'é˜¿è˜‡å¿…åƒç¾é£Ÿï¼ŒåŠç†Ÿç´…ç‰›è‚‰é‹ªæ»¿ä¸¼é£¯ã€‚',
        tips: ['ğŸ”¥ å¿…åƒï¼šèµ¤ç‰›ä¸¼', 'ğŸ’¡ å¦‚æœImakinæ’å¤ªä¹…ï¼Œå¯å» Meshi-no-sato']
      },
      {
        id: '3-3',
        time: '14:00',
        title: 'è‰åƒé‡Œä¹‹æ¿± & é˜¿è˜‡ç«å£',
        type: 'spot',
        location: 'é˜¿è˜‡å±±è‰åƒé‡Œ',
        description: 'ä¸€æœ›ç„¡éš›çš„å¤§è‰åŸèˆ‡å†’ç…™çš„ç«å±±å£ã€‚',
        tips: ['ğŸ’¡ å±±ä¸Šé¢¨å¤§ï¼Œè«‹å¸¶åšå¤–å¥—', 'ğŸ’¡ å¿…è²·ï¼šé˜¿è˜‡ç‰›å¥¶å†°æ·‡æ·‹']
      },
      {
        id: '3-4',
        time: '15:30',
        title: 'å¤§è§€å³°å±•æœ›æ‰€',
        type: 'spot',
        location: 'å¤§è§€å³°',
        description: '360åº¦çœºæœ›é˜¿è˜‡äº”å²³(æ¶…æ§ƒåƒ)çš„æœ€ä½³åœ°é»ã€‚',
      },
      {
        id: '3-5',
        time: '16:30',
        title: 'é»‘å·æº«æ³‰ Check-in',
        type: 'hotel',
        location: 'é»’å·æ¸©æ³‰ ã‚„ã¾ã³ã“æ—…é¤¨',
        description: 'å…¥ä½æ—¥å¼æº«æ³‰æ—…é¤¨ï¼Œäº«å—ä»™äººé¢¨å‘‚ã€‚',
        bookingCode: 'JAPANICAN-9921',
        tips: ['ğŸ’¡ è³¼è²·ã€Œå…¥æ¹¯æ‰‹å½¢ã€å¯æ³¡ä¸‰é–“ä¸åŒæº«æ³‰', 'ğŸ’¡ æ™šé¤å‰å…ˆå»æ³¡æ¹¯']
      }
    ]
  },
  {
    date: '12/6',
    dayOfWeek: 'é€±å…­',
    weather: { temp: '5Â°C', icon: 'cloud' },
    items: [
      {
        id: '4-1',
        time: '10:00',
        title: 'ä¸Šè‰²è¦‹ç†Šé‡åº§ç¥ç¤¾',
        type: 'spot',
        location: 'ä¸Šè‰²è¦‹ç†Šé‡åº§ç¥ç¤¾',
        description: 'é€šå¾€ç•°ä¸–ç•Œçš„å…¥å£ï¼Œå……æ»¿é’è‹”çš„ç¥ç§˜éšæ¢¯ã€‚',
        tips: ['ğŸ“¸ å¿…æ‹ï¼šåƒé“éšæ¢¯èˆ‡ç©¿é€å²©çŸ³çš„é¢¨ç©´']
      },
      {
        id: '4-2',
        time: '12:00',
        title: 'é«˜æ£®ç”°æ¨‚ä¿å­˜æœƒ (åˆé¤)',
        type: 'food',
        location: 'é«˜æ£®ç”°æ¥½ä¿å­˜ä¼š',
        description: 'åœè‘—åœ°çˆåƒå‘³å™Œçƒ¤ä¸²ï¼Œéå¸¸æœ‰æ°£æ°›ã€‚',
      },
      {
        id: '4-3',
        time: '13:30',
        title: 'å¤©å²©æˆ¶ç¥ç¤¾ & å¤©å®‰æ²³åŸ',
        type: 'spot',
        location: 'å¤©å²©æˆ¸ç¥ç¤¾ è¥¿æœ¬å®®',
        description: 'æ—¥æœ¬ç¥è©±èµ·æºåœ°ï¼Œåœ¨æ­¤å †çŸ³é ­è¨±é¡˜ã€‚',
      },
      {
        id: '4-4',
        time: '15:00',
        title: 'Solest Takachiho Hotel',
        type: 'hotel',
        location: 'Solest Takachiho Hotel',
        description: 'Check-in ä¼‘æ¯ã€‚',
        bookingCode: 'BOOKING-1122'
      },
      {
        id: '4-5',
        time: '17:00',
        title: 'é«˜åƒç©—ç‡’è‚‰ã€Œå’Œã€',
        type: 'food',
        location: 'é«˜åƒç©‚ç‰›ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å’Œ',
        description: 'é ‚ç´šé«˜åƒç©—ç‰›ç‡’è‚‰ã€‚',
        tips: ['âš ï¸ éœ€æå‰é ç´„', 'ğŸ”¥ å¿…é»ï¼šé«˜åƒç©—ç‰›é‡Œè„Š'],
        bookingCode: 'TEL-RES-NAME-CHEN'
      },
      {
        id: '4-6',
        time: '20:00',
        title: 'é«˜åƒç©—ç¥æ¨‚',
        type: 'spot',
        location: 'é«˜åƒç©—ç¥ç¤¾',
        description: 'å¤œç¥æ¨‚è¡¨æ¼”ï¼Œé«”é©—æ—¥æœ¬å‚³çµ±æ–‡åŒ–ã€‚',
        tips: ['ğŸ’¡ 19:00 é–‹æ”¾å…¥å ´ï¼Œå»ºè­°ææ—©å»ä½”ä½']
      }
    ]
  },
  {
    date: '12/7',
    dayOfWeek: 'é€±æ—¥',
    weather: { temp: '9Â°C', icon: 'sun' },
    items: [
      {
        id: '5-1',
        time: '09:00',
        title: 'é«˜åƒç©—å³½ åˆ’èˆ¹',
        type: 'spot',
        location: 'é«˜åƒç©—å³½æ·¡æ°´é­šæ°´æ—é¤¨(ä¹˜èˆ¹è™•)',
        description: 'åœ¨å³½è°·ä¸­åˆ’èˆ¹ï¼Œè¿‘è·é›¢çœ‹çœŸåäº•ç€‘å¸ƒã€‚',
        tips: ['âš ï¸ å‹™å¿…äº‹å…ˆä¸Šç¶²é ç´„', 'ğŸ“¸ å¿…æ‹ï¼šç€‘å¸ƒèˆ‡èˆ¹çš„åˆå½±'],
        bookingCode: 'BOAT-RES-3344'
      },
      {
        id: '5-2',
        time: '12:00',
        title: 'æµæ°´ç´ éºµ (åˆé¤)',
        type: 'food',
        location: 'åƒç©—ä¹‹å®¶',
        description: 'é«”é©—ç«¹ç®¡æµæ°´ç´ éºµã€‚',
      },
      {
        id: '5-3',
        time: '15:00',
        title: 'ç†Šæœ¬é‚„è»Š',
        type: 'transport',
        location: 'TOYOTA Rent a Car ç†Šæœ¬ç«™å‰åº—',
        description: 'åŠ æ»¿æ²¹å¾Œé‚„è»Šã€‚',
      },
      {
        id: '5-4',
        time: '15:30',
        title: 'CANDEN HOTEL ç†Šæœ¬',
        type: 'hotel',
        location: 'CANDEO HOTELS ç†Šæœ¬æ–°å¸‚è¡—',
        description: 'Check-inï¼Œä½æ–¼æ–°å¸‚è¡—å•†åº—è¡—å…§ã€‚',
        bookingCode: 'AGODA-8811'
      }
    ]
  },
  {
    date: '12/8',
    dayOfWeek: 'é€±ä¸€',
    weather: { temp: '11Â°C', icon: 'sun' },
    items: [
      {
        id: '6-1',
        time: '10:00',
        title: 'ç†Šæœ¬åŸ & åŸå½©è‹‘',
        type: 'spot',
        location: 'ç†Šæœ¬åŸ',
        description: 'åƒè§€ä¿®å¾©ä¸­çš„ç†Šæœ¬åŸå¤©å®ˆé–£èˆ‡åŸä¸‹ç”ºã€‚',
        tips: ['ğŸ¦ å¿…åƒï¼šåŸå½©è‹‘çš„æµ·è†½å¯æ¨‚é¤…', 'ğŸ“¸ å¤©å®ˆé–£é ‚æ¨“é¢¨æ™¯']
      },
      {
        id: '6-2',
        time: '12:30',
        title: 'ç†Šæœ¬æ‹‰éºµ (åˆé¤)',
        type: 'food',
        location: 'é»‘äº­æ‹‰éºµ / æ¡‚èŠ±æ‹‰éºµ',
        description: 'ç‰¹è‰²æ˜¯æ¿ƒéƒçš„ç„¦é¦™è’œæ²¹ã€‚',
      },
      {
        id: '6-3',
        time: '14:30',
        title: 'ä¸‹é€š/ä¸Šé€šå•†åº—è¡—',
        type: 'spot',
        location: 'ç†Šæœ¬ä¸‹é€šå•†åº—è¡—',
        description: 'æœ€å¾Œæ¡è²·ä¼´æ‰‹ç¦®ã€‚',
        tips: ['ğŸ›ï¸ å¿…é€›ï¼šé¶´å±‹ç™¾è²¨ç†Šæœ¬ç†Šéƒ¨é•·è¾¦å…¬å®¤', 'ğŸ›ï¸ è—¥å¦åº—æ¯”åƒ¹']
      },
       {
        id: '6-4',
        time: '18:00',
        title: 'ç†Šæœ¬é¦¬è‚‰æ–™ç† (æ™šé¤)',
        type: 'food',
        location: 'ç®¡ä¹ƒå±‹ / é¦¬æ«»',
        description: 'ç†Šæœ¬åç‰©ç”Ÿé¦¬è‚‰é«”é©—ã€‚',
      }
    ]
  },
  {
    date: '12/9',
    dayOfWeek: 'é€±äºŒ',
    weather: { temp: '13Â°C', icon: 'cloud' },
    items: [
      {
        id: '7-1',
        time: '09:00',
        title: 'å‰å¾€æ©Ÿå ´',
        type: 'transport',
        location: 'ç†Šæœ¬æ«»ç”ºå·´å£«ç¸½ç«™',
        description: 'æ­ä¹˜æ©Ÿå ´å·´å£«å‰å¾€ç†Šæœ¬æ©Ÿå ´ã€‚',
      },
      {
        id: '7-2',
        time: '11:45',
        title: 'æ˜Ÿå®‡èˆªç©º JX847',
        type: 'flight',
        location: 'ç†Šæœ¬æ©Ÿå ´ (KMJ)',
        description: 'é£›å¾€æ¡ƒåœ’ (TPE)ï¼Œé è¨ˆ 13:25 æŠµé”ã€‚',
        bookingCode: 'REF: KYU-1209-STAR'
      },
      {
        id: '7-3',
        time: '15:43',
        title: 'å°ç£é«˜éµ',
        type: 'transport',
        location: 'é«˜éµæ¡ƒåœ’ç«™',
        description: 'æ­ä¹˜é«˜éµè¿”å›å°å—ã€‚',
      }
    ]
  }
];

// --- Components ---

const WeatherBadge = ({ temp, icon }: { temp: string; icon: 'sun' | 'rain' | 'cloud' }) => {
  const getIcon = () => {
    switch(icon) {
      case 'sun': return <Sun size={16} className="text-orange-500" />;
      case 'rain': return <CloudRain size={16} className="text-blue-500" />;
      default: return <Cloud size={16} className="text-gray-500" />;
    }
  };
  return (
    <div className="flex items-center gap-1 bg-white/80 backdrop-blur px-2 py-1 rounded-full text-xs font-medium shadow-sm border border-stone-200">
      {getIcon()}
      <span className="text-stone-700">{temp}</span>
    </div>
  );
};

const CategoryIcon = ({ type }: { type: string }) => {
  switch (type) {
    case 'flight': return <Plane size={18} className="text-sky-600" />;
    case 'transport': return <Train size={18} className="text-indigo-600" />;
    case 'food': return <Utensils size={18} className="text-orange-600" />;
    case 'hotel': return <Home size={18} className="text-emerald-600" />;
    case 'spot': return <Camera size={18} className="text-rose-600" />;
    default: return <MapPin size={18} className="text-gray-600" />;
  }
};

const DetailModal = ({ item, onClose }: { item: ItineraryItem; onClose: () => void }) => {
  if (!item) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-[#fdfbf7] w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden border border-stone-200">
        <div className="p-4 border-b border-stone-200 flex justify-between items-center bg-white">
          <h3 className="font-bold text-stone-800 text-lg flex items-center gap-2">
            <CategoryIcon type={item.type} />
            {item.title}
          </h3>
          <button onClick={onClose} className="p-1 hover:bg-stone-100 rounded-full">
            <X size={20} className="text-stone-500" />
          </button>
        </div>
        
        <div className="p-5 space-y-4">
          <div className="space-y-1">
            <p className="text-xs font-bold text-stone-400 uppercase tracking-wider">TIME & LOCATION</p>
            <p className="text-stone-800 font-medium text-lg">{item.time}</p>
            <p className="text-stone-600">{item.location}</p>
          </div>

          {item.bookingCode && (
            <div className="bg-stone-100 p-3 rounded-lg border border-stone-200 dashed">
              <p className="text-xs text-stone-500 mb-1">é ç´„/è¨‚ä½ä»£è™Ÿ</p>
              <p className="font-mono text-lg font-bold text-stone-800 tracking-wider">{item.bookingCode}</p>
            </div>
          )}

          {item.description && (
             <div className="space-y-1">
               <p className="text-xs font-bold text-stone-400 uppercase tracking-wider">DETAILS</p>
               <p className="text-stone-700 leading-relaxed text-sm">{item.description}</p>
             </div>
          )}
          
          {item.tips && item.tips.length > 0 && (
            <div className="bg-amber-50 p-3 rounded-lg border border-amber-100">
              <p className="text-xs font-bold text-amber-600 mb-2 flex items-center gap-1">
                <Info size={12} /> é”äººç­†è¨˜
              </p>
              <ul className="space-y-1">
                {item.tips.map((tip, idx) => (
                  <li key={idx} className="text-xs text-amber-900 flex items-start gap-1">
                    <span>â€¢</span>
                    <span>{tip}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}

          <a 
            href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`}
            target="_blank"
            rel="noopener noreferrer"
            className="flex items-center justify-center gap-2 w-full py-3 bg-stone-800 text-white rounded-xl hover:bg-stone-700 transition-colors font-medium shadow-lg shadow-stone-200"
          >
            <Navigation size={18} />
            é–‹å•Ÿ Google Maps å°èˆª
          </a>
        </div>
      </div>
    </div>
  );
};

const ToolsSection = () => {
  const [expenses, setExpenses] = useState<{item: string, price: number}[]>([
    { item: 'ç¦å²¡åˆé¤', price: 2500 },
    { item: 'ä¾¿åˆ©å•†åº—', price: 800 }
  ]);
  const [newExpense, setNewExpense] = useState('');
  const [newPrice, setNewPrice] = useState('');

  const addExpense = () => {
    if (newExpense && newPrice) {
      setExpenses([...expenses, { item: newExpense, price: parseInt(newPrice) }]);
      setNewExpense('');
      setNewPrice('');
    }
  };

  const total = expenses.reduce((sum, curr) => sum + curr.price, 0);

  return (
    <div className="space-y-6 p-1 pb-20">
      <div className="bg-white rounded-xl p-4 shadow-sm border border-stone-100">
        <h3 className="font-bold text-stone-800 mb-3 flex items-center gap-2">
          <Phone size={18} className="text-rose-500" /> ç·Šæ€¥è¯çµ¡
        </h3>
        <div className="space-y-3 text-sm">
          <div className="flex justify-between border-b border-stone-50 pb-2">
            <span className="text-stone-500">æ•‘è­·è»Š/ç«è­¦</span>
            <span className="font-mono font-bold text-rose-600">119</span>
          </div>
          <div className="flex justify-between border-b border-stone-50 pb-2">
            <span className="text-stone-500">è­¦å¯Ÿå±€</span>
            <span className="font-mono font-bold text-rose-600">110</span>
          </div>
          <div className="flex justify-between">
            <span className="text-stone-500">å°åŒ—é§å¤§é˜ªè¾¦äº‹è™•ç¦å²¡åˆ†è™•</span>
            <span className="font-mono font-bold text-stone-800">092-734-2810</span>
          </div>
        </div>
      </div>

      <div className="bg-white rounded-xl p-4 shadow-sm border border-stone-100">
        <h3 className="font-bold text-stone-800 mb-3 flex items-center gap-2">
          <Briefcase size={18} className="text-indigo-500" /> èˆªç­è³‡è¨Š
        </h3>
        <div className="bg-indigo-50 rounded-lg p-3 mb-2">
          <div className="flex justify-between text-xs text-indigo-400 mb-1">12/03 å»ç¨‹</div>
          <div className="font-bold text-indigo-900">JX 846 TPE - KMJ</div>
          <div className="text-sm text-indigo-700">07:30 - 10:30</div>
        </div>
        <div className="bg-indigo-50 rounded-lg p-3">
          <div className="flex justify-between text-xs text-indigo-400 mb-1">12/09 å›ç¨‹</div>
          <div className="font-bold text-indigo-900">JX 847 KMJ - TPE</div>
          <div className="text-sm text-indigo-700">11:45 - 13:25</div>
        </div>
      </div>

      <div className="bg-white rounded-xl p-4 shadow-sm border border-stone-100">
        <h3 className="font-bold text-stone-800 mb-3 flex items-center gap-2">
          <CreditCard size={18} className="text-emerald-500" /> è¨˜å¸³å°å¹«æ‰‹ (JPY)
        </h3>
        <div className="flex gap-2 mb-4">
          <input 
            type="text" 
            placeholder="é …ç›®" 
            className="flex-1 bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-stone-400"
            value={newExpense}
            onChange={(e) => setNewExpense(e.target.value)}
          />
          <input 
            type="number" 
            placeholder="Â¥" 
            className="w-20 bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-stone-400"
            value={newPrice}
            onChange={(e) => setNewPrice(e.target.value)}
          />
          <button 
            onClick={addExpense}
            className="bg-stone-800 text-white px-3 rounded-lg text-sm font-medium"
          >
            +
          </button>
        </div>
        <div className="space-y-2 max-h-40 overflow-y-auto">
          {expenses.map((ex, i) => (
            <div key={i} className="flex justify-between text-sm text-stone-600">
              <span>{ex.item}</span>
              <span className="font-mono">Â¥{ex.price}</span>
            </div>
          ))}
        </div>
        <div className="mt-3 pt-3 border-t border-stone-100 flex justify-between font-bold text-stone-800">
          <span>Total</span>
          <span className="font-mono text-emerald-600">Â¥{total}</span>
        </div>
      </div>
    </div>
  );
};

export default function KyushuTravelLog() {
  const [activeTab, setActiveTab] = useState<'itinerary' | 'tools'>('itinerary');
  const [selectedDayIndex, setSelectedDayIndex] = useState(0);
  const [selectedItem, setSelectedItem] = useState<ItineraryItem | null>(null);

  const currentDay = itineraryData[selectedDayIndex];

  return (
    <div className="min-h-screen bg-[#f5f2eb] font-sans text-stone-800 flex flex-col items-center">
      {/* Container for mobile-first simulation */}
      <div className="w-full max-w-md bg-[#fdfbf7] min-h-screen shadow-2xl relative flex flex-col">
        
        {/* Header */}
        <header className="sticky top-0 z-10 bg-[#fdfbf7]/90 backdrop-blur-md border-b border-stone-200 px-5 py-4 flex justify-between items-end">
          <div>
            <p className="text-xs font-bold text-stone-400 tracking-widest uppercase mb-1">JAPAN TRIP 2024</p>
            <h1 className="text-2xl font-bold text-stone-800 font-serif">ä¹å·æ—…å¸–</h1>
          </div>
          {activeTab === 'itinerary' && (
            <div className="text-right">
              <WeatherBadge temp={currentDay.weather.temp} icon={currentDay.weather.icon} />
            </div>
          )}
        </header>

        {/* Content Area */}
        <main className="flex-1 overflow-y-auto scrollbar-hide">
          
          {activeTab === 'itinerary' ? (
            <>
              {/* Date Selector */}
              <div className="sticky top-[73px] z-10 bg-[#fdfbf7] py-2 border-b border-stone-100 shadow-sm">
                <div className="flex overflow-x-auto px-4 gap-3 pb-2 scrollbar-hide snap-x">
                  {itineraryData.map((day, idx) => (
                    <button
                      key={day.date}
                      onClick={() => setSelectedDayIndex(idx)}
                      className={`flex-shrink-0 snap-center flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all duration-300 ${
                        selectedDayIndex === idx 
                          ? 'bg-stone-800 text-white shadow-lg scale-105' 
                          : 'bg-white text-stone-400 border border-stone-100'
                      }`}
                    >
                      <span className="text-xs font-medium">{day.date}</span>
                      <span className={`text-sm font-bold ${selectedDayIndex === idx ? 'text-stone-200' : 'text-stone-600'}`}>
                        {day.dayOfWeek}
                      </span>
                    </button>
                  ))}
                </div>
              </div>

              {/* Timeline Items */}
              <div className="p-5 pb-24 space-y-6">
                {currentDay.items.map((item, idx) => (
                  <div key={item.id} className="relative pl-6 group">
                    {/* Timeline Line */}
                    {idx !== currentDay.items.length - 1 && (
                      <div className="absolute left-[11px] top-8 bottom-[-24px] w-[2px] bg-stone-200" />
                    )}
                    
                    {/* Timeline Dot */}
                    <div className={`absolute left-0 top-1.5 w-6 h-6 rounded-full border-4 border-[#fdfbf7] flex items-center justify-center
                      ${item.type === 'transport' ? 'bg-indigo-500' : 
                        item.type === 'food' ? 'bg-orange-500' : 
                        item.type === 'spot' ? 'bg-rose-500' : 
                        item.type === 'flight' ? 'bg-sky-500' : 'bg-emerald-500'}`}
                    >
                    </div>

                    {/* Card */}
                    <div 
                      onClick={() => setSelectedItem(item)}
                      className="bg-white rounded-xl p-4 shadow-sm border border-stone-100 active:scale-98 transition-transform cursor-pointer hover:shadow-md"
                    >
                      <div className="flex justify-between items-start mb-2">
                        <span className="text-xs font-mono font-bold text-stone-400 bg-stone-50 px-2 py-0.5 rounded">
                          {item.time}
                        </span>
                        {item.bookingCode && (
                          <span className="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded border border-emerald-100">
                            å·²é ç´„
                          </span>
                        )}
                      </div>
                      
                      <div className="flex gap-3">
                        <div className="flex-1">
                          <h3 className="font-bold text-stone-800 text-base mb-1">{item.title}</h3>
                          <p className="text-xs text-stone-500 line-clamp-1 mb-2">{item.location}</p>
                          
                          {/* Mini Tags */}
                          {item.tips && (
                             <div className="flex flex-wrap gap-1 mt-2">
                               {item.tips.slice(0, 2).map((tip, i) => (
                                 <span key={i} className="text-[10px] bg-amber-50 text-amber-700 px-1.5 py-0.5 rounded border border-amber-100">
                                   {tip}
                                 </span>
                               ))}
                             </div>
                          )}
                        </div>
                        <div className="flex flex-col items-center justify-center pl-2 border-l border-stone-100 text-stone-300">
                          <ChevronRight size={20} />
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </>
          ) : (
            <div className="p-5">
              <ToolsSection />
            </div>
          )}
        </main>

        {/* Bottom Tab Bar */}
        <nav className="sticky bottom-0 bg-white border-t border-stone-200 px-6 py-3 flex justify-around pb-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
          <button 
            onClick={() => setActiveTab('itinerary')}
            className={`flex flex-col items-center gap-1 transition-colors ${activeTab === 'itinerary' ? 'text-stone-800' : 'text-stone-400'}`}
          >
            <Calendar size={24} strokeWidth={activeTab === 'itinerary' ? 2.5 : 2} />
            <span className="text-[10px] font-medium">è¡Œç¨‹</span>
          </button>
          
          <div className="w-px h-8 bg-stone-200 mx-2 self-center"></div>

          <button 
            onClick={() => setActiveTab('tools')}
            className={`flex flex-col items-center gap-1 transition-colors ${activeTab === 'tools' ? 'text-stone-800' : 'text-stone-400'}`}
          >
            <Briefcase size={24} strokeWidth={activeTab === 'tools' ? 2.5 : 2} />
            <span className="text-[10px] font-medium">å·¥å…·ç®±</span>
          </button>
        </nav>

        {/* Modal */}
        {selectedItem && (
          <DetailModal item={selectedItem} onClose={() => setSelectedItem(null)} />
        )}

      </div>
    </div>
  );
}
